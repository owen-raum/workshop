version: '3.8'

services:
  builder:
    image: node:21
    working_dir: /build
    volumes:
      - app_source:/build
      - build_dist:/build/dist
      - node_modules:/build/node_modules
    command: >
      /bin/sh -c "
        if [ ! -f /build/package.json ]; then
          echo 'Cloning repo...' &&
          apt-get update -qq && apt-get install -y -qq git > /dev/null 2>&1 &&
          git clone https://github.com/owen-raum/workshop.git /tmp/repo &&
          cp -r /tmp/repo/* /tmp/repo/.* /build/ 2>/dev/null || true;
        fi &&
        npm install --include=dev --legacy-peer-deps &&
        npx vite build"
    environment:
      - NODE_ENV=production

  web:
    image: node:21
    working_dir: /app
    environment:
      - PORT=${WEBSERVER_PORT:-9019}
      - NODE_ENV=production
    volumes:
      - build_dist:/app/dist
    ports:
      - "${WEBSERVER_PORT:-9019}:${WEBSERVER_PORT:-9019}"
    depends_on:
      - builder
    command: npx serve -s ./dist -l ${WEBSERVER_PORT:-9019} --cors
    restart: unless-stopped
    networks:
      pulse:
        ipv4_address: ${IPV4_ADDRESS:-10.0.10.19}

volumes:
  app_source:
  build_dist:
  node_modules:

networks:
  pulse:
    external: true
